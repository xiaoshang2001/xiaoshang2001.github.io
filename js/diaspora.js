var xhr,Home=location.href,Pages=4,xhrUrl="",Diaspora={L:function(o,e,n){if(o==xhrUrl)return!1;xhrUrl=o,xhr&&xhr.abort(),xhr=$.ajax({type:"GET",url:o,timeout:1e4,success:function(t){e(t),xhrUrl=""},error:function(t,e,a){"abort"==e?n&&n():window.location.href=o,xhrUrl=""}})},P:function(){return!!("ontouchstart"in window)},PS:function(){window.history&&history.pushState&&(history.replaceState({u:Home,t:document.title},document.title,Home),window.addEventListener("popstate",function(t){var e=t.state;e&&(document.title=e.t,e.u==Home?($("#preview").css("position","fixed"),setTimeout(function(){$("#preview").removeClass("show"),$("#container").show(),window.scrollTo(0,parseInt($("#container").data("scroll"))),setTimeout(function(){$("#preview").html(""),$(window).trigger("resize")},300)},0)):(Diaspora.loading(),Diaspora.L(e.u,function(t){document.title=e.t,$("#preview").html($(t).filter("#single")),Diaspora.preview(),setTimeout(function(){Diaspora.player()},0)})))}))},HS:function(t,e){var a=t.data("id")||0,o=t.attr("href"),n=t.attr("title")+" - "+$("#config-title").text();$("#preview").length&&window.history&&history.pushState||(location.href=o),Diaspora.loading();var i={d:a,t:n,u:o};Diaspora.L(o,function(t){if($(t).filter("#single").length){switch(e){case"push":history.pushState(i,n,o);break;case"replace":history.replaceState(i,n,o)}switch(document.title=n,$("#preview").html($(t).filter("#single")),e){case"push":Diaspora.preview();break;case"replace":window.scrollTo(0,0),Diaspora.loaded()}setTimeout(function(){Diaspora.player(),$("#top").show(),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click()},0);t=document.getElementById("single");MathJax.Hub.Queue(["Typeset",MathJax.Hub,t])}else location.href=o})},preview:function(){$("#preview").one("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",function(){$("#preview").hasClass("show")?$("#container").hide():$("#container").show(),Diaspora.loaded()}),setTimeout(function(){$("#preview").addClass("show"),$("#container").data("scroll",window.scrollY),setTimeout(function(){$("#preview").css({position:"static","overflow-y":"auto"})},500)},0)},player:function(){var e=$("#audio");e.length?(""==$("#audio source").eq(0).attr("src")&&""==e[0].src&&(audiolist=$("#audio-list li"),mp3=audiolist.eq([Math.floor(Math.random()*audiolist.size())]),e[0].src=mp3.data("url")),1==e.eq(0).data("autoplay")&&e[0].play(),e.on({timeupdate:function(){var t=e[0].currentTime/e[0].duration*100;$(".bar").css("width",t+"%"),e[0].volume=t/5<=1?t/5:1},ended:function(){$(".icon-pause").removeClass("icon-pause").addClass("icon-play")},playing:function(){$(".icon-play").removeClass("icon-play").addClass("icon-pause")}})):$(".icon-play").css({color:"#dedede",cursor:"not-allowed"})},loading:function(){var t=window.innerWidth,e='<style class="loaderstyle" id="loaderstyle'+t+'">@-moz-keyframes loader'+t+"{100%{background-position:"+t+"px 0}}@-webkit-keyframes loader"+t+"{100%{background-position:"+t+"px 0}}.loader"+t+"{-webkit-animation:loader"+t+" 3s linear infinite;-moz-animation:loader"+t+" 3s linear infinite;}</style>";$(".loaderstyle").remove(),$("head").append(e),$("#loader").removeClass().addClass("loader"+t).show()},loaded:function(){$("#loader").removeClass().hide()},F:function(t,e,a){var o=$(t).parent().height(),n=$(t).parent().width(),e=a/e;e<o/n?(t.style.height=o+"px",t.style.width=o/e+"px"):(t.style.width=n+"px",t.style.height=n*e+"px"),t.style.left=(n-parseInt(t.style.width))/2+"px",t.style.top=(o-parseInt(t.style.height))/2+"px"}};$(function(){var i,t;Diaspora.P()&&$("body").addClass("touch"),$("#preview").length?((i={}).t=$("#cover"),i.w=i.t.attr("width"),i.h=i.t.attr("height"),(i.o=function(){$("#mark").height(window.innerHeight)})(),i.t.prop("complete")&&setTimeout(function(){i.t.load()},0),i.t.on("load",function(){(i.f=function(){var t,e,a=$("#mark").width(),o=$("#mark").height(),n=1e3<=a||1e3<=o?1e3:500;o<=a?t=(e=a/n*50)*a/o:e=(t=o/n*50)*o/a,$(".layer").css({width:a+t,height:o+e,marginLeft:-.5*t,marginTop:-.5*e}),i.w||(i.w=i.t.width(),i.h=i.t.height()),Diaspora.F($("#cover")[0],i.w,i.h)})(),setTimeout(function(){$("html, body").removeClass("loading")},1e3),$("#mark").parallax();var t=new Vibrant(i.t[0]).swatches();t.DarkVibrant&&($("#vibrant polygon").css("fill",t.DarkVibrant.getHex()),$("#vibrant div").css("background-color",t.DarkVibrant.getHex())),t.Vibrant&&($(".icon-menu").css("color",t.Vibrant.getHex()),$(".icon-search").css("color",t.Vibrant.getHex()))}),i.t.attr("src")||alert("Please set the post thumbnail"),$("#preview").css("min-height",window.innerHeight),Diaspora.PS(),$(".pview a").addClass("pviewa"),$(window).on("resize",function(){clearTimeout(t),t=setTimeout(function(){Diaspora.P()||location.href!=Home||(i.o(),i.f()),$("#loader").attr("class")&&Diaspora.loading()},500)})):($("#single").css("min-height",window.innerHeight),setTimeout(function(){$("html, body").removeClass("loading")},1e3),window.addEventListener("popstate",function(t){t.state&&(location.href=t.state.u)}),Diaspora.player(),$(".icon-icon, .image-icon").attr("href","/"),$("#top").show()),$(window).on("scroll",function(){var t,e;!$(".scrollbar").length||Diaspora.P()||$(".icon-images").hasClass("active")||(t=$(window).scrollTop(),e=$("#top").width()/(document.body.scrollHeight-$(window).height())*t,$(".scrollbar").width(e),80<t&&800<window.innerWidth?$(".subtitle").fadeIn():$(".subtitle").fadeOut())}),$(window).on("touchmove",function(t){$("body").hasClass("mu")&&t.preventDefault()});function l(t,o,n){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),t=document.getElementById(o),a=document.getElementById(n);t.addEventListener("input",function(){var d='<ul class="search-result-list">',u=this.value.trim().toLowerCase().split(/[\s\-]+/);a.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var a,e,o,n=!0,i=t.title.trim().toLowerCase(),r=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),s=t.url,l=-1,c=-1;""!=i&&""!=r&&u.forEach(function(t,e){a=i.indexOf(t),l=r.indexOf(t),a<0&&l<0?n=!1:(l<0&&(l=0),0==e&&(c=l))}),n&&(d+="<li><a href='"+s+"' class='search-result-title' target='_blank'>"+i+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=c&&(s=c+6,(s=0==(t=(t=c-6)<0?0:t)?10:s)>e.length&&(s=e.length),o=e.substr(t,s),u.forEach(function(t){var e=new RegExp(t,"gi");o=o.replace(e,'<em class="search-keyword">'+t+"</em>")}),d+='<p class="search-result">'+o+"...</p>"))}),a.innerHTML=d)})}})}var c="/search.xml";null!==document.getElementById("local-search-input")&&l(c,"local-search-input","local-search-result");var d=null;$("body").on("click",function(a){var o=$(a.target).attr("class")||"",t=$(a.target).attr("rel")||"";if((o="IMG"==a.target.nodeName&&0<$(a.target).parents("div.content").length?"pimg":o)||t)switch(!0){case-1!=o.indexOf("switchmenu"):return window.scrollTo(0,0),$("html, body").toggleClass("mu"),null!==d?(d.destroy(),d=null):1==$("#hitokoto").data("st")&&$.get("https://v1.hitokoto.cn/",function(t){t={strings:[(t=t).hitokoto+" ——  By "+t.from],typeSpeed:90,startDelay:500};d=new Typed(".hitokoto .typed",t)}),!1;case-1!=o.indexOf("switchsearch"):return $("body").removeClass("mu"),null!==d&&(d.destroy(),d=null),setTimeout(function(){Diaspora.HS($(a.target),"push"),$(".toc").fadeIn(1e3),l(c,"local-search-input","local-search-result")},300),!1;case-1!=o.indexOf("more"):if("loading"==(o=$(".more")).data("status"))return!1;var e=parseInt(o.data("page"))||1;return(1==e&&o.data("page",1),Pages<=e)?void 0:(o.html("加载中...").data("status","loading"),Diaspora.loading(),Diaspora.L(o.attr("href"),function(t){var e=$(t).find(".more").attr("href");null!=e?(o.attr("href",e).html("加载更多").data("status","loaded"),o.data("page",parseInt(o.data("page"))+1)):$("#pager").remove();e=$(window).scrollTop();$("#primary").append($(t).find(".post")),$(window).scrollTop(e+100),Diaspora.loaded(),$("html,body").animate({scrollTop:e+400},500)},function(){o.html("加载更多").data("status","loaded")}),!1);case-1!=o.indexOf("icon-home"):return $(".toc").fadeOut(100),$("#preview").hasClass("show")?history.back():location.href=$(".icon-home").data("url"),!1;case-1!=o.indexOf("icon-scan"):return $(".icon-scan").hasClass("tg")?$("#qr").toggle():($(".icon-scan").addClass("tg"),$("#qr").qrcode({width:128,height:128,text:location.href}).toggle()),!1;case-1!=o.indexOf("icon-play"):return $("#audio")[0].play(),$(".icon-play").removeClass("icon-play").addClass("icon-pause"),!1;case-1!=o.indexOf("icon-pause"):return $("#audio")[0].pause(),$(".icon-pause").removeClass("icon-pause").addClass("icon-play"),!1;case-1!=o.indexOf("cover"):return Diaspora.HS($(a.target).parent(),"push"),!1;case-1!=o.indexOf("posttitle"):return Diaspora.HS($(a.target),"push"),!1;case"prev"==t||"next"==t:return s=("prev"==t?$("#prev_next a")[0]:$("#prev_next a")[1]).text,$(a.target).attr("title",s),Diaspora.HS($(a.target),"replace"),!1;case-1!=o.indexOf("toc-text")||-1!=o.indexOf("toc-link")||-1!=o.indexOf("toc-number"):return hash="",hash=("SPAN"==a.target.nodeName?$(a.target).parent():$(a.target)).attr("href"),to=$(decodeURI(hash)),$("html,body").animate({scrollTop:to.offset().top-50},300),!1;case-1!=o.indexOf("pviewa"):return $("body").removeClass("mu"),null!==d&&(d.destroy(),d=null),setTimeout(function(){Diaspora.HS($(a.target),"push"),$(".toc").fadeIn(1e3)},300),!1;case-1!=o.indexOf("pimg"):var n,i,r,s=$(".pswp").get(0);return s&&(n=[],i=0,r=[],$(".content img").each(function(t,e){a.target.src==e.src&&(i=t);t={src:e.src,w:e.naturalWidth,h:e.naturalHeight};r.push(e),n.push(t)}),new PhotoSwipe(s,PhotoSwipeUI_Default,n,{index:i,shareEl:!1,zoomEl:!1,allowRotationOnUserZoom:!0,history:!1,getThumbBoundsFn:function(t){var e=r[t],t=window.pageYOffset||document.documentElement.scrollTop,e=e.getBoundingClientRect();return{x:e.left,y:e.top+t,w:e.width}}}).init()),!1;case-1!=o.indexOf("comment"):return 1==$("#gitalk-container").data("enable")?(Diaspora.loading(),comment=$("#gitalk-container"),gitalk=new Gitalk({clientID:comment.data("ci"),clientSecret:comment.data("cs"),repo:comment.data("r"),owner:comment.data("o"),admin:comment.data("a"),id:decodeURI(window.location.pathname),distractionFreeMode:comment.data("d")}),$(".comment").removeClass("link"),gitalk.render("gitalk-container"),Diaspora.loaded()):$("#gitalk-container").html("评论已关闭"),!1;default:return!0}}),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click(),console.log("%c Github %c","background:#24272A; color:#ffffff","","https://github.com/Fechin/hexo-theme-diaspora")});